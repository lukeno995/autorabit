<apex:page standardController="Case" extensions="PO_TP_Buttons_Controller" showHeader="false" sidebar="false">
<apex:includeScript value="/support/console/36.0/integration.js"/>
<apex:includeScript value="/soap/ajax/20.0/connection.js"/> 
<apex:stylesheet value="{!URLFOR($Resource.LDS, 'assets/styles/salesforce-lightning-design-system.min.css')}"/>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>    
    
<script type="text/javascript">

    function redirect(idNotify, recordTypeNotify){        
        //Original redirect method
        if(sforce.console.isInConsole()){
        // global vars
        var url2open = "";
        var tabTitle = "";﻿
         
        // open URLs in new tabs - CONSOLE TOOLKIT REQUIRED﻿
        function openUrl(p_url2open, p_tabTitle) {
               try{
                     window.parent.openUrl(p_url2open, p_tabTitle);
               }catch(e){
                      // load global variables
                      url2open = p_url2open;
                      tabTitle = p_tabTitle;
                      // go
                      sforce.console.getEnclosingPrimaryTabId(openurl_subtab);
               }
        };
         
         
        var openurl_subtab = function(result) {
               var primaryTabId = result.id;
               // open tabs
              sforce.console.openSubtab(primaryTabId, url2open, true, tabTitle, null, null);
                
              sforce.console.refreshPrimaryTabById(primaryTabId, true);
        }﻿
        var rtn = recordTypeNotify.replace(/Notifica/gi, "Not.");
        openUrl("/"+idNotify+"/e?retURL={!Case.Id}", rtn);  
        }
        else if ("{!$User.UIThemeDisplayed}" == "Theme4d"){
            sforce.one.navigateToURL("/"+y+"/e");
            sforce.one.back(true);
        }
        else{
            window.top.location.href ="/"+y+"/e?retURL={!Case.Id}"; 
        }         
    };
    
    function refresh(){
        if (sforce.console.isInConsole()){
                 
            var refresh_subtab = function(result) {
                var primaryTabId = result.id;
                // open tabs
                sforce.console.refreshPrimaryTabById(primaryTabId, true);
            }﻿  
            sforce.console.getEnclosingPrimaryTabId(refresh_subtab);
            
        }
        else if ("{!$User.UIThemeDisplayed}" == "Theme4d"){
            sforce.one.navigateToURL("/{!Case.Id}");
            sforce.one.back(true);
        }
        else{
             window.top.location.href ="/{!Case.Id}";
        }           
};
    
    
    function refiresh2(ass){
        //CRM Modifica 31_08_2017 Aggiunti due controlli ulteriori: 1.FL_1FieldEmpty 2.FL_2FieldEmpty
        if(ass=="true"){
            alert("Ci sono collegamenti non assegnati a nessuna area geografica");
        }
        else if(ass=="NO"){
            alert("Il campo Esito Collegamento non è stato valorizzato");
        }else if( ass === 'FL_1FieldEmpty')
        {
            alert("Il campo BB 1° interessato (m) non è stato valorizzato");
        }
        //14/09/2017 CRM Commentato perchè non va più fatto questo controllo
        //19/09/2017 CRM decommentato
        else if( ass === 'FL_2FieldEmpty')
        {
            alert("Il campo Posa 1 nuovo Drop (m) non è stato valorizzato");
        }
        //19/09/2017 CRM
        else if( ass === 'LunghFieldEmpty')
        {
            alert("Il campo Lunghezza Drop FL 1 (m) non è stato valorizzato");
        }
        //19/09/2017 END CRM
        else{ 
            window.top.location.href ="/{!Case.Id}";
        }
    }
    function refresh2(){
       // window.top.location.href="/apex/BOOperatorAppuntamentoOKPage";  
          if (sforce.console.isInConsole()){
                 
            var refresh_subtab = function(result) {
                var primaryTabId = result.id;
                // open tabs
            //   sforce.console.refreshPrimaryTabById(primaryTabId, true);
                alert("primary tab "+primaryTabId );
            }﻿  
            var showTabId = function showTabId(result) {
                // Display the tab ID 
                alert("Tab ID: " + result.id);
            }
            
            sforce.console.getEnclosingPrimaryTabId(refresh_subtab);
            alert("111--"+sforce.console.getEnclosingPrimaryTabId(refresh_subtab));
            alert("hiiii");
            //system.debug("focuseed --"+sforce.console.getFocusedPrimaryTabId(showTabId));
            
            donotchange();
            
        }
        else if ("{!$User.UIThemeDisplayed}" == "Theme4d"){
            sforce.one.navigateToURL("/{!Case.Id}");
            sforce.one.back(true);
        }
        else{
            window.top.location.href ="/{!Case.Id}";
        }      
};

    //ADD PG - 15-10
    function modificaCampi(){
        if(sforce.console.isInConsole()){       
          sforce.console.openPrimaryTab(null,"/apex/PO_TP_EditFieldsCase_page?retURL={!Case.Id}&Id={!Case.Id}");
          testCloseTab(); 
        }
        else{
          window.top.location.href ="/apex/PO_TP_EditFieldsCase_page?retURL={!Case.Id}&Id={!Case.Id}";
        }
    }

    function editCase(){
        if(sforce.console.isInConsole()){       
          sforce.console.openPrimaryTab(null,"/{!Case.Id}/e?retURL={!Case.Id}",true, x);
          testCloseTab(); 
        }
        else{
          window.top.location.href ="/{!Case.Id}/e?retURL={!Case.Id}";
        }
    }
    function openNotifyCloseCase(x){
    
        if(x=='NetCreToTecFat'){
            var oper=x;
            var OLO='false';
        }
        if(x=='TecFatToRefFat'){
            var oper=x;
            var OLO='false';
        }
        if(x=='SupVenToNetCre'){
            var oper=x;
            var OLO='false';
        }
        if(x=='NetCreToSupVen'){
            var oper=x;
            var OLO='false';
        }
        
        if(x=='DelToSupVen'){
            var oper=x;
            var OLO='false';
        }
        if(x=='SupVenToRefFat'){
            var oper=x;
            var OLO='false';
        }
        if(x=='RefFatToTecFat'){
            var oper=x;
            var OLO='false';
        }
        if(x=='RefFatToSupVen'){
            var oper=x;
            var OLO='false';
        }
        if(x=='SupVen'){
            var oper=x;
            var OLO='false';
        }
        
        if(x=='Note Referente'){
            var oper='RefFatToSupVen';
            var OLO='false';
        }
        if(x=='TecFatToNetCre'){
            var oper=x;
            var OLO='false';
        }
        if(x=='Note Delivery'){
            var oper='Del';
            var OLO='false';
        }
       
        if(x=='Espletamento OK'){
            var oper='EspOK';
            var OLO='true';
        }
        if(x=='Data Attivazione Ordine'){
            alert("Compilare il campo '"+x+"'");
            return;
        } 
        if(x=='ID Risorsa'){
            alert("Compilare il campo '"+x+"'");
            return;
        } 
        if(x=='Espletamento KO'){
            var oper='EspKO';
            var OLO='true';
        }
        if(x=='Sospensione'){
            var oper='Sos'; 
            var OLO='true';
        }
        if(x=='Desospensione'){
            var oper='Des';
            var OLO='true';
        }
        if(x=='Annullamento'){
            var oper='Ann';
            var OLO='true';
        }
        
        if(sforce.console.isInConsole()){       
          sforce.console.openPrimaryTab(null,"/apex/PO_PhaseTransictions_Page?retURL={!Case.Id}&Id={!Case.Id}&Oper="+oper+"&OLO="+OLO,true, x);
          testCloseTab(); 
        }
        else{
          window.top.location.href ="/apex/PO_PhaseTransictions_Page?retURL={!Case.Id}&Id={!Case.Id}&Oper="+oper+"&OLO="+OLO;
        }
    }

    function openPhaseTransictionsPage(x){
        if(sforce.console.isInConsole()){       
          sforce.console.openPrimaryTab(null,"/apex/PO_TP_ButtonsPhaseTransition_Page?retURL={!Case.Id}&Id={!Case.Id}&proc="+x,true, "{!Case.CaseNumber}");
          testCloseTab(); 
        }
        else{
           
          window.top.location.href ="/apex/PO_TP_ButtonsPhaseTransition_Page?retURL={!Case.Id}&Id={!Case.Id}&proc="+x;
        }
    }


    function testCloseTab(){
            //First find the ID of the current tab to close it
            sforce.console.getEnclosingTabId(closeSubtab);
        }
        
    var closeSubtab = function closeSubtab(result){
            //Now that we have the tab ID, we can close it
            var tabId = result.id;
            sforce.console.closeTab(tabId);
        };    
  </script>
    
  <body id="buttonBlock"> 
    <apex:form style="padding-top: 10px">
        <apex:messages />

    <apex:outputText rendered="{!If(Case.ClosedDate!=null,true,false)}" ><b>Segnalazione in {!Case.Status}</b></apex:outputText>
    
    <apex:outputpanel rendered="{!If(Case.ClosedDate=null,true,false)}">
        <apex:outputText rendered="{!If(Case.owner.type=='Queue' && showButtonBlock,'true','false')}" ><b>In {!Case.Owner.name}, in attesa di presa in carico </b></apex:outputText>
        <apex:outputpanel rendered="{!If(originalCase.ownerId=attuale.Id,'true','false')}">
            <apex:commandLink value="Invia alla coda territoriale" 
            rendered="{!If(destinatario='Coda Territoriale' && showButtonBlock,'true','false')}" reRender="buttonBlock"
                              styleClass="slds-button slds-button--brand" style="margin-right:5px;" onclick="openPhaseTransictionsPage('pass')"/>
            <apex:commandLink value="Invia al SOC" rendered="{!If(destinatario='SOC' && showButtonBlock,'true','false')}" 
            reRender="buttonBlock" styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
            onclick="openPhaseTransictionsPage('pass')"/>
            
            <!-- START - Add by PG - 16-05 per gestire la differenza tra Segnalazione Prov e Incident Management -->
            <apex:commandLink value="Chiudi Segnalazione" reRender="buttonBlock" 
                rendered="{!IF(OR(originalCase.EOF_Fase__c='In Lavorazione SOC') && showButtonBlock,'true','false')}"  
                styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
                onclick="openPhaseTransictionsPage('close')"/>
            
            <apex:commandLink value="Chiudi Segnalazione" reRender="buttonBlock" 
                rendered="{!IF(OR(originalCase.EOF_Fase__c='In Lavorazione Operation') && showButtonBlock,'true','false')}"  
                styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
                onclick="openPhaseTransictionsPage('closeIncident')"/>
            <!-- END - Add by PG - 16-05 per gestire la differenza tra Segnalazione Prov e Incident Management -->
        </apex:outputpanel>
        
        <!-- modifica per CR07 Provisioning  Aggiunta note OLO-OF -->
        <!--    
            <apex:commandLink value="Inserisci Nota" reRender="buttonBlock"
            styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
            onclick="openPhaseTransictionsPage('addNote')" />   
        -->
            <!-- Inserisci Nota per Segnalazione Prov -->
            <apex:commandLink value="Inserisci Nota" reRender="buttonBlock"
                styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
                rendered="{!IF(OR(originalCase.EOF_Fase__c='In Lavorazione SOC') && showButtonBlock,'true','false')}"  
                onclick="openPhaseTransictionsPage('addNote')" /> 
            
            <!-- Inserisci Nota per Incident Management -->
            <apex:commandLink value="Inserisci Nota" reRender="buttonBlock"
	            rendered="{!If(AND(originalCase.Status='In Lavorazione' && originalCase.EOF_Fase__c='In Lavorazione Operation'),true, false)}"
                styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
                onclick="openPhaseTransictionsPage('addNoteInc')" /> 
                
            <!-- START - Add by PG - 16-10 - tasto Modifica visibile solo dopo presa in carico -->
            <apex:outputPanel rendered="{!(originalCase.subject=='Incident Management')}">
                <apex:commandLink value="Modifica" reRender="buttonBlock" styleClass="slds-button slds-button--brand" 
                    style="margin-right:5px;" onclick="modificaCampi()" 
                    rendered="{!If(originalCase.Status='In Lavorazione',true, false)}" >
                </apex:commandLink>
            </apex:outputPanel>
            
            <apex:outputPanel rendered="{!(IF(AND(originalCase.subject=='Segnalazione Provisioning') && (Case.owner.type!='Queue'),true, false))}">
            <apex:commandLink value="Modifica" reRender="buttonBlock" styleClass="slds-button slds-button--brand" 
                style="margin-right:5px;" onclick="modificaCampi()" 
                rendered="{!IF(OR(originalCase.EOF_Fase__c='In Lavorazione SOC') || originalCase.EOF_Fase__c='In Lavorazione Coda Territoriale' && showButtonBlock,'true','false')}">
            </apex:commandLink>
            </apex:outputPanel>
            <!-- END - Add by PG - 16-10 - tasto Modifica visibile solo dopo presa in carico -->
        
        <!-- END - CR07 Aggiunta note OLO-OF rendered="{!If(originalCase.Owner.Type='Queue' && showButtonBlock,'true','false')}" -->
        
        <apex:commandLink action="{!PrendiInCarico}" value="Prendi In Carico" reRender="buttonBlock"
            styleClass="slds-button slds-button--brand" style="margin-right:5px;" 
            rendered="{!If(originalCase.Owner.Type='Queue' && showButtonBlock,'true','false')}" oncomplete="refresh()"/>    


    </apex:outputpanel>
    </apex:form>     
    
  </body>    
</apex:page>