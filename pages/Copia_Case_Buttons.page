<apex:page standardController="Case" extensions="Copia_Controller_Case_Buttons" showHeader="false" sidebar="false">
<apex:includeScript value="/support/console/36.0/integration.js"/>
<apex:includeScript value="/soap/ajax/20.0/connection.js"/>
<apex:stylesheet value="{!URLFOR($Resource.LDS, 'assets/styles/salesforce-lightning-design-system.min.css')}"/>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    
<script type="text/javascript">
    
    function redirect(idNotify, recordTypeNotify){        
                
        //Original redirect method
        if(sforce.console.isInConsole()){
        // global vars
        var url2open = '';
        var tabTitle = '';﻿
         
        // open URLs in new tabs - CONSOLE TOOLKIT REQUIRED﻿
        function openUrl(p_url2open, p_tabTitle) {
               try{
                     window.parent.openUrl(p_url2open, p_tabTitle);
               }catch(e){
                      // load global variables
                      url2open = p_url2open;
                      tabTitle = p_tabTitle;
                      // go
                      sforce.console.getEnclosingPrimaryTabId(openurl_subtab);
               }
        };
         
        var openurl_subtab = function(result) {
               var primaryTabId = result.id;
               // open tabs
              sforce.console.openSubtab(primaryTabId, url2open, true, tabTitle, null, null);
                
              sforce.console.refreshPrimaryTabById(primaryTabId, true);
        }﻿
        var rtn = recordTypeNotify.replace(/Notifica/gi, "Not.");
        openUrl('/'+idNotify+'/e?retURL={!Case.Id}', rtn);  
        }
        else if ('{!$User.UIThemeDisplayed}' == 'Theme4d'){
            sforce.one.navigateToURL('/'+y+'/e');
            sforce.one.back(true);
        }
        else{
            window.top.location.href ='/'+y+'/e?retURL={!Case.Id}'; 
        }         
    };
    
    function refresh(){
        if (sforce.console.isInConsole()){
                 
            var refresh_subtab = function(result) {
                var primaryTabId = result.id;
                // open tabs
                sforce.console.refreshPrimaryTabById(primaryTabId, true);
            }﻿  
            sforce.console.getEnclosingPrimaryTabId(refresh_subtab);
            
        }
        else if ('{!$User.UIThemeDisplayed}' == 'Theme4d'){
            sforce.one.navigateToURL('/{!Case.Id}');
            sforce.one.back(true);
        }
        else{
             window.top.location.href ='/{!Case.Id}';
        }           
};
    
    function appuntamentoKoClick(){        
        var r = confirm('Ci sono stati 12 tentativi di contatto non riusciti?', 'Salesforce'); 
        if (r == true){ 
         	appuntamentoKOfunction();
         }  
}  
    
    function refresh2(){
       // window.top.location.href='/apex/BOOperatorAppuntamentoOKPage';  
          if (sforce.console.isInConsole()){
                 
            var refresh_subtab = function(result) {
                var primaryTabId = result.id;
                // open tabs
            //   sforce.console.refreshPrimaryTabById(primaryTabId, true);
                alert('primary tab '+primaryTabId );
            }﻿  
            var showTabId = function showTabId(result) {
                // Display the tab ID 
                alert('Tab ID: ' + result.id);
            }
            
            sforce.console.getEnclosingPrimaryTabId(refresh_subtab);
            alert('111--'+sforce.console.getEnclosingPrimaryTabId(refresh_subtab));
            alert('hiiii');
            //system.debug('focuseed --'+sforce.console.getFocusedPrimaryTabId(showTabId));
            
            donotchange();
            
        }
        else if ('{!$User.UIThemeDisplayed}' == 'Theme4d'){
            sforce.one.navigateToURL('/{!Case.Id}');
            sforce.one.back(true);
        }
        else{
             window.top.location.href ='/{!Case.Id}';
        }      
};

    function openNotifyCloseCase(idNotify, recordTypeNotify){        
        sforce.console.openPrimaryTab(null,'/' + idNotify + '/e?retURL={!Case.Id}',true, recordTypeNotify);
        testCloseTab(); 
        }
    
    function testCloseTab(){
            //First find the ID of the current tab to close it
            sforce.console.getEnclosingTabId(closeSubtab);
        }
        
    var closeSubtab = function closeSubtab(result){
            //Now that we have the tab ID, we can close it
            var tabId = result.id;
            sforce.console.closeTab(tabId);
        };    
</script>
    
<body> 
	<apex:pageBlock id="hiddenBlock" rendered="false"></apex:pageBlock>
	<apex:form style="padding-top: 10px">
    	<apex:messages />
	<apex:outputpanel rendered="{!If(Case.EOF_Order_Manager__c,false,true)}">
    <apex:outputText rendered="{!If(Case.owner.name='Coda Operatori BO' || Case.owner.name='Coda Operatori Tecnici','true','false')}" >In {!Case.Owner.name}, in attesa di presa in carico</apex:outputText>
        
    <apex:commandLink action="{!create_notify}" value="Verifiche preliminari OK" reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:5px;" rendered="{!IF((Case.status='Acquisito' && Case.EOF_Fase__c='In Verifica BO' && 
                                                                                                      Case.recordType.name='EOF Caso - Attivazione')&&
                                                                            (Case.owner.name!='Coda Operatori BO')&&
                                                                            (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="6" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="OK" />
    </apex:commandLink>  

    <apex:commandLink action="{!create_notify}" value="Verifiche preliminari KO"  reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:8px;"
                      rendered="{!IF((Case.status='Acquisito' && Case.EOF_Fase__c='In Verifica BO' && Case.recordType.name='EOF Caso - Attivazione')&&
                                                                            (Case.owner.name!='Coda Operatori BO')&&
                                                                            (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="6" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="KO" />
    </apex:commandLink>

   <apex:commandLink action="{!contact_result}" value="Invio verso Tecnico" reRender="hiddenBlock" oncomplete="refresh()"
                     styleClass="slds-button slds-button--brand" style="margin-right:8px;"
                     rendered="{!IF(
                               (((Case.status='Accettato' && Case.EOF_Fase__c='Da contattare')||(Case.status='Accettato' && Case.EOF_Fase__c='Desospeso')) && Case.recordType.name='EOF Caso - Attivazione')&&
                               (Case.owner.name!='Coda Operatori BO')&&(Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="thirdParam" assignTo="{!contactStatus}" value="OK" />
    </apex:commandLink>      
      
     <apex:commandLink value="Appuntamento KO"  reRender="hiddenBlock"  onclick="appuntamentoKoClick();"
                       styleClass="slds-button slds-button--brand" style="margin-right:8px;"
                       rendered="{!IF(
                                 (((Case.status='Accettato' && Case.EOF_Fase__c='Da contattare')||(Case.status='Accettato' && Case.EOF_Fase__c='Desospeso')) && Case.recordType.name='EOF Caso - Attivazione')&&
                                                                             (Case.owner.name!='Coda Operatori BO')&&(Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
     </apex:commandLink>     
    <apex:actionFunction action="{!create_notify}" id="appuntamentoKOfunctionId" name="appuntamentoKOfunction" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');" rerender="none">  
       <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
       <apex:param name="secondParam" assignTo="{!notifyType}" value="9" />  
      </apex:actionFunction>    
      
    <apex:commandLink action="{!create_notify}" value="Cessato OK" reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:5px;" rendered="{!IF((Case.status='Acquisito' && Case.EOF_Fase__c='In Lavorazione')&&
                                                                            (Case.owner.name!='Coda Operatori BO')&&
                                                                            (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="12" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="OK" />
        </apex:commandLink>
       
    <apex:commandLink action="{!create_notify}" value="Cessato KO"  reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:8px;" rendered="{!IF((Case.status='Acquisito' && Case.EOF_Fase__c='In Lavorazione')&&
                                                                            (Case.owner.name!='Coda Operatori BO')&&
                                                                            (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="12" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="KO" />
    </apex:commandLink>

    <apex:commandLink action="{!create_notify}" value="Espletato OK" reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:5px;"
                      rendered="{!IF((Case.status='Accettato' && Case.EOF_Fase__c='In Lavorazione')&&
                                (Case.owner.name!='Coda Operatori BO')&&(Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="7" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="OK" />
    </apex:commandLink>
        
    <apex:commandLink action="{!create_notify}" value="Espletato KO"  reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      styleClass="slds-button slds-button--brand" style="margin-right:8px;"
                      rendered="{!IF((Case.status='Accettato' && Case.EOF_Fase__c='In Lavorazione')&&
                                     (Case.owner.name!='Coda Operatori BO')&&(Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="7" />
        <apex:param name="thirdParam" assignTo="{!notifyStatus}" value="KO" />
        </apex:commandLink>   
        
        <apex:commandLink action="{!create_notify}" value="Rimodulazione DAC"  reRender="hiddenBlock" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');"
                      target="_top"  styleClass="slds-button slds-button--brand" style="margin-right:8px;" rendered="{!IF(                                                                                           
                                                                                           ((Case.status=='Accettato' && Case.EOF_Fase__c=='Desospeso')||
                                                                                           (Case.status=='Accettato' && Case.EOF_Fase__c=='Da contattare')||
                                                                                           (Case.status=='Acquisito' && Case.EOF_Fase__c=='In Verifica BO')||
                                                                                           (Case.status=='Sospeso'))&&
                                                                                           (Case.EOF_Fase__c!='In Lavorazione')&&
                                                                                           (Case.owner.name!='Coda Operatori BO')&&
                                                                                           (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="8" />
    </apex:commandLink>
 
    <apex:commandLink action="{!create_notify}" value="Sospendi" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');" reRender="hiddenBlock"
                      styleClass="slds-button slds-button--brand" style="margin-right:5px;" rendered="{!IF((Case.status='Accettato' && Case.EOF_Fase__c='In Lavorazione')&&
                                                                             (Case.owner.name!='Coda Operatori BO')&&
                                                                             (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="9" />
    </apex:commandLink>    
   
    <apex:commandLink action="{!create_notify}" value="Desospendi" oncomplete="openNotifyCloseCase('{!idNotify}','{!recordTypeNotify}');" reRender="hiddenBlock"
                      styleClass="slds-button slds-button--brand" style="margin-right:5px;" rendered="{!IF((Case.status='Sospeso')&&(Case.owner.name!='Coda Operatori BO')&&
                                                                            (Case.owner.name!='Coda Operatori Tecnici'),'true','false')}">
        <apex:param name="firstParam" assignTo="{!CaseId}" value="{!Case.Id}" />
        <apex:param name="secondParam" assignTo="{!notifyType}" value="10" />
    </apex:commandLink>
    </apex:outputpanel>
    </apex:form>
    
</body>    
</apex:page>